# Кейс № 1: Автоматизация мониторинга пользовательских реакций  
**Команда:**  
- Шалунов Андрей (Product Owner)  
- Оспельников Алексей (Data Scientist)  
- Ананьев Никита (Software Architect)   

---

# 1. Цели и предпосылки

## 1.1 Зачем идём в разработку продукта?
- **Рост нагрузки и скорость обработки.** В нашей социальной сети ежедневно публикуется до 500 000 комментариев. Ручная модерация требует десятков сотрудников и не укладывается в регламент Роскомнадзора по времени реакции.  
- **Объективность и консистентность.** Люди по-разному оценивают похожие комментарии, что приводит к жалобам и снижению доверия.  
- **Снижение рисков штрафов.** Роскомнадзор требует блокировки критичных публикаций в течение 1 часа после появления. Автоматизация поможет гарантировать соблюдение SLA.  
- **Увеличение вовлечённости.** При обнаружении негатива система предлагает альтернативный позитивный контент, повышая время сессии и лояльность пользователей.

![](https://github.com/nikita-itmo-gh-acc/content_reaction_auto/blob/main/bpmn-before.png?raw=true)

## 1.2 Почему станет лучше от использования ML?
- **Скорость и масштабируемость.** ML-модель обрабатывает сотни тысяч комментариев в секунду и масштабируется горизонтально в облаке «Яндекс.Облако».  
- **Консистентность решений.** Модель выдаёт единообразные оценки тональности, устраняя человеческий фактор.  
- **Адаптивность.** Регулярное дообучение на новых примерах и мониторинг «дрифта» лексики (сбор меток от модераторов, анализ ошибок) поддерживает актуальность классификации.  
- **Экономия ресурсов.** Снижение ручной модерации на 50 % позволяет оптимизировать расходы.

![](https://github.com/nikita-itmo-gh-acc/content_reaction_auto/blob/main/bpmn-after.png?raw=true)

## 1.3 Бизнес-требования и ограничения
| Параметр                  | Значение                                                                                             |
|---------------------------|------------------------------------------------------------------------------------------------------|
| **SLA модерации**         | Блокировка негативных/запрещённых комментариев в течение 1 часа после публикации.                     |
| **Доступность**           | ≥ 99.5 % в месяц (не более 3.6 ч простоев).                                                          |
| **Хранение данных**       | Персональные данные (IP, никнейм) хранятся до 6 месяцев, затем архивация в Хранилище «Яндекс.S3» или удаление по запросу. |
| **Бюджет**                | Разработка: до 1 500 000 ₽; эксплуатация: до 150 000 ₽/мес.                                           |
| **Команда**               | 2–3 инженера, 1 ML-разработчик, 1 аналитик.     

## 1.4 Функциональные и нефункциональные требования

| Тип                     | Требование                                                                                                                                                  |
|-------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Функциональные**    | 1. Классификация комментариев по тональности (позитив/нейтраль/негатив).<br>2. Выделение токсичных и спам-сообщений.<br>3. Интерфейс обратной связи для модераторов.<br>4. Регулярная публикация дашборда с отчётами (Яндекс.Метрика, Grafana). |
| **Нефункциональные**  | 1. Latency ≤ 200 мс на одну проверку.<br>2. Throughput ≥ 5 000 запросов/сек (пики до 10 000 запросов/сек).<br>3. Безопасность API (OAuth2, HTTPS, OpenID Connect).<br>4. Логирование и мониторинг (Яндекс.Мониторинг + Grafana). |

## 1.5 Процесс пилота и критерии успеха
1. **Сбор и предобработка данных.**  
   - Исторические комментарии: 30 000 записей с ручными метками.  
   - Очистка текста, нормализация, токенизация, удаление «шума».  
2. **Разделение выборки:** train (70 %), validation (15 %), test (15 %).  
3. **Обучение базовой модели:** fine-tuning RuBERT через Grid Search гиперпараметров.  
4. **Валидация:** метрики Precision, Recall, F1, latency p95.  
5. **Dry-run в тестовой среде:** интеграция ML-API с тестовым клиентом, проверка логирования и трассировки.  
6. **A/B-тест:** 10 % трафика — ML-система, 90 % — ручная модерация.

**Критерии успеха:**  
- F1-score ≥ 0.85 на тестовой выборке  
- Latency p95 ≤ 200 мс при нагрузке 1 000 req/s  
- Сокращение ручной модерации минимум на 40 %

## 1.6 MVP vs технический долг
- **MVP включает:**  
  1. Классификация тональности (3 класса).  
  2. REST-API (FastAPI + Docker).  
  3. Мини-дашборд (Grafana).  
  4. Интерфейс обратной связи для модераторов.

- **Технический долг:**  
  1. Онлайн-дообучение.  
  2. Мультимодальность (картинки, эмодзи).  
  3. Автоматическая корректировка на основе фидбэка.  
  4. Расширенный мониторинг чатов и комментариев.

# 2. Методология

## 2.1 Технический подход
- **Тип модели:** классификация текста (multi-class classification).  
- **Алгоритм:** трансформеры (fine-tuning RuBERT или аналогичной модели).  
- **Инструменты:** Python, PyTorch, Hugging Face Transformers, Docker, Kubernetes в «Яндекс.Облаке».

## 2.2 Необходимые данные
- **Комментарии:** текст, метки тональности (позитив/нейтрал/негатив).  
- **Метаданные:** `user_id`, `comment_id`, `timestamp`.  
- **История модерации:** решения модераторов (правильный/неправильный прогноз).  
- **Опционально:** число лайков, жалоб, длина комментария, геоданные.

## 2.3 Метрики качества и связь с бизнес-результатом
| Метрика           | Описание                                            | Влияние на бизнес                                        |
|-------------------|-----------------------------------------------------|----------------------------------------------------------|
| **Precision**     | Доля корректно найденных негативных комментариев.   | Снижает число ложных блокировок — повышает лояльность.   |
| **Recall**        | Доля обнаруженных всех негативных комментариев.     | Минимизирует риск штрафов от Роскомнадзора.              |
| **F1-score**      | Гармоническое среднее precision и recall.           | Баланс между безопасностью и удобством пользователей.    |
| **Latency (p95)** | Время обработки 95 % запросов.                      | Соответствие SLA ≤ 200 мс.                               |


## 2.4 Риски и планы по смягчению
- **Дисбаланс классов.** Негативных комментариев меньше.  
  _Митигирующие меры:_ oversampling «негатива», loss-weighting, синтетическая генерация.  
- **Шумные метки.** Ошибки в ручной разметке.  
  _Митигирующие меры:_ ревью спорных примеров, доп. верификация модераторами.  
- **Дрифт языка.** Новый сленг, мемы.  
  _Митигирующие меры:_ периодическое дообучение на ливай датасете, мониторинг метрик качества.  
- **Перегрузка инфраструктуры.** Пиковые нагрузки.  
  _Митигирующие меры:_ авто-скейлинг в «Яндекс.Облаке», rate limiting на уровне Ingress.

# 3. Подготовка пилота

## 3.1 Способ оценки
- Прогнозы на отложенной тестовой выборке (15 %).  
- A/B-тест: сравнение ручной и автоматической модерации по KPI (F1, latency, % false positive).

## 3.2 Что считаем успешным пилотом
- **F1 ≥ 0.85** на тестовой выборке.  
- **Latency p95 ≤ 200 мс** при нагрузке 1 000 запросов/сек.  
- **Сокращение ручной работы** модераторов минимум на 40 %.

## 3.3 Шаги подготовки
1. Интеграция REST-API ML-модуля в тестовую среду (FastAPI + Docker).  
2. Наполнение «песочницы» историческими данными (30 000 комментариев).  
3. Настройка мониторинга и алертинга в «Яндекс.Мониторинг» + Grafana.  
4. Dry-run: обработка старых комментариев без влияния на прод.

# 4. Внедрение в production

## 4.1 Архитектура решения

![](https://github.com/nikita-itmo-gh-acc/content_reaction_auto/blob/main/data-arch.png?raw=true)

## 4.2 Компоненты решения

- **API Service**  
  Принимает HTTP-запросы, вызывает ML-модель и возвращает прогноз тональности.

- **ML Model Pods**  
  Несколько экземпляров RuBERT в Kubernetes для горизонтального масштабирования и высокой доступности.

- **Logging & Audit**  
  Хранит входные данные, предсказание модели и финальное решение модератора в Yandex ClickHouse или Elasticsearch.

- **Monitoring**  
  Сбор метрик (latency, error rate, throughput) в «Яндекс.Мониторинг», визуализация в Grafana.

![](https://github.com/nikita-itmo-gh-acc/content_reaction_auto/blob/main/uml-components.png?raw=true)
![](https://github.com/nikita-itmo-gh-acc/content_reaction_auto/blob/main/uml-sequence.png?raw=true)


---

## 4.3 Инфраструктура и масштабируемость

- **Яндекс Kubernetes**  
  - Авто-скейлинг и self-healing  
  - Интеграция с CI/CD (GitHub Actions, GitLab CI)

- **Хранение данных**  
  - **Hot storage:** Yandex Managed ClickHouse для OLTP и аналитики в реальном времени  
  - **Cold storage:** Yandex Object Storage (S3-совместимый) для архивов и дообучения моделей

![](https://github.com/nikita-itmo-gh-acc/content_reaction_auto/blob/main/er-diagram.png?raw=true)
---

## 4.4 Требования к работе системы

- **SLA:** доступность ≥ 99.5 % (не более 3.6 ч простоев в месяц)  
- **RPS:** пиковая нагрузка до 10 000 запросов/сек  
- **Latency:**  
  - p50 ≤ 100 мс  
  - p95 ≤ 200 мс  
- **Безопасность:**  
  - HTTPS/TLS для всего трафика  
  - OAuth2 / OpenID Connect  
  - Шифрование данных in transit и at rest

---

## 4.5 Риски и неопределённости

- **Дрифт данных:** регулярный мониторинг качества модели и периодическое дообучение на новом датасете.  
- **Пиковые нагрузки:** резервные ML-поды («горячие» резервы), rate limiting на уровне Ingress.  
- **Зависимость от сервисов:** fallback-механизмы (кеширование), дублирование хранилищ.  
- **Регуляторные изменения:** гибкие бизнес-правила в конфиге без перекомпиляции модели.  
